<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TaraCommute â€“ Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link rel="icon" href="assets/logo.png?v=2" type="image/png"/>

  <!-- Mapbox -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <link rel="stylesheet" href="css/dashboard.css" />
</head>

<body>
  <div class="aurora aurora--neon" aria-hidden="true"></div>
  <div id="map"></div>

  <div class="panel">
    <div class="panelHeader">
      <div>
        <div class="title">TaraCommute â€“ Departure Boards</div>
        <div class="sub">Jeep â€¢ Bus â€¢ Ferry â€¢ LRT</div>
          <div class="sub" id="userLabel" style="margin-top:6px;"></div>
          <div class="sub" id="sessionLabel" style="margin-top:4px; opacity:.9;"></div>

      </div>
      <button id="themeToggle" class="secondary">Dark Mode</button>
        <button id="logoutBtn" class="btnLogout">Log out</button>

    </div>

    <div class="tabs" id="tabs"></div>
    <!-- ðŸš† Rail Line Legend -->
    <div class="legend" id="railLegend">
    </div>



    <div class="controls">
  <input id="search" placeholder="Search (route/station/destination)..." />
  <button id="clearSearch" class="secondary">Clear</button>
</div>


    <div id="boardContainer"></div>
  </div>

  <!-- âœ… Load auth FIRST -->
  <script src="js/auth.js"></script>

  <!-- âœ… Guard + Logout (ONE unified block) -->
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // ðŸ”’ Guard
    const auth = window.TaraAuth?.getAuth?.();
    if (!auth || auth.loggedIn !== true) {
      window.location.replace("index.html");
      return;
    }

    // ðŸ‘¤ Show user email/name
    const userLabel = document.getElementById("userLabel");
    if (userLabel) {
      const display =
        auth.name && auth.name.trim().length
          ? `${auth.name} (${auth.email})`
          : auth.email;

      userLabel.textContent = `Logged in as: ${display}`;
    }

    // â³ Session countdown (only shows if expiresAt exists)
    const sessionLabel = document.getElementById("sessionLabel");

    function fmt(ms) {
      const total = Math.max(0, Math.floor(ms / 1000));
      const m = String(Math.floor(total / 60)).padStart(2, "0");
      const s = String(total % 60).padStart(2, "0");
      return `${m}:${s}`;
    }

    function updateSessionUI() {
      const latest = window.TaraAuth?.getAuth?.(); // re-read in case it expires
      if (!latest) {
        window.location.replace("index.html");
        return;
      }

      if (sessionLabel) {
        if (latest.expiresAt) {
          const left = latest.expiresAt - Date.now();
          sessionLabel.textContent =
            left > 0 ? `Session expires in: ${fmt(left)}` : "Session expired.";
        } else {
          sessionLabel.textContent = ""; // hide if you don't use expiry yet
        }
      }
    }

    updateSessionUI();
    const timer = setInterval(updateSessionUI, 1000);

    // ðŸšª Logout
    const logoutBtn = document.getElementById("logoutBtn");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", () => {
        clearInterval(timer);
        window.TaraAuth.clearAuth();
        window.location.replace("index.html");
      });
    }
  });
</script>

<script>
  (function () {
    const STORAGE_KEY = "tara_theme";
    const btn = document.getElementById("themeToggle");

    function setTheme(theme) {
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem(STORAGE_KEY, theme);
      if (btn) btn.textContent = theme === "dark" ? "Light Mode" : "Dark Mode";
    }

    // Load saved theme OR system preference
    const saved = localStorage.getItem(STORAGE_KEY);
    const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
    setTheme(saved || (prefersDark ? "dark" : "light"));

    // Toggle on click
    if (btn) {
      btn.addEventListener("click", () => {
        const current = document.documentElement.getAttribute("data-theme") || "light";
        setTheme(current === "dark" ? "light" : "dark");
      });
    }
  })();
</script>




  <!-- âœ… Your existing scripts -->
  <script src="js/config.js"></script>
  <script src="js/map.js"></script>

  <script src="js/boards/boardBase.js"></script>
  <script src="js/boards/jeepBoard.js"></script>
  <script src="js/boards/busBoard.js"></script>
  <script src="js/boards/ferryBoard.js"></script>
  <script src="js/boards/lrtBoard.js"></script>
  <script src="js/boards/lrt2Board.js"></script>
  <script src="js/boards/mrtBoard.js"></script>
  <script src="js/boards/app.js"></script>

  <!-- ðŸ¤– Commute Buddy Button (floats beside map) -->
<button id="commuteBuddyBtn" title="Talk to Commute Buddy">
  ðŸ¤– Commute Buddy
</button>

<!-- Commute Buddy Chat Panel -->
<div id="commuteBuddyPanel" class="cb-hidden">
  <div class="cb-header">
    <span>Commute Buddy</span>
    <button id="cbClose">âœ•</button>
  </div>

  <div id="cbMessages" class="cb-messages"></div>

  <div class="cb-input-area">
    <input type="text" id="cbInput" placeholder="Ask about routes, traffic, commute tips..." />
    <button id="cbSend">Send</button>
  </div>
</div>

<div id="cbBackdrop" class="cb-hidden"></div>

<script src="js/commuteBuddy.js"></script>
<script>
  (function () {
    const root = document.documentElement;
    const reduceMotion = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;

    root.style.setProperty("--mx", "50%");
    root.style.setProperty("--my", "50%");
    if (reduceMotion) return;

    let targetX = 50, targetY = 50;
    let currentX = 50, currentY = 50;
    const ease = 0.06; 

    function onMove(e) {
      const x = (e.clientX / window.innerWidth) * 100;
      const y = (e.clientY / window.innerHeight) * 100;
      targetX = Math.max(0, Math.min(100, x));
      targetY = Math.max(0, Math.min(100, y));
    }

    window.addEventListener("mousemove", onMove, { passive: true });
    window.addEventListener("touchmove", (e) => {
      if (!e.touches || !e.touches[0]) return;
      onMove(e.touches[0]);
    }, { passive: true });

    (function loop(){
      currentX += (targetX - currentX) * ease;
      currentY += (targetY - currentY) * ease;
      root.style.setProperty("--mx", currentX.toFixed(2) + "%");
      root.style.setProperty("--my", currentY.toFixed(2) + "%");
      requestAnimationFrame(loop);
    })();
  })();
</script>

</body>
</html>